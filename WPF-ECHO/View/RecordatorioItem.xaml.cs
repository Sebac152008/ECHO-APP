// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, métodos y herramientas ya creadas que puedes utilizar
// sin necesidad de escribir su ruta completa en cada referencia.

// -------- ESPACIOS DE NOMBRES DEL SISTEMA --------

// 'System' proporciona clases fundamentales del núcleo de .NET, como manejo de cadenas (string), fechas (DateTime), tipos numéricos, etc.
using System;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Collections.Generic' permite trabajar con estructuras de datos dinámicas como listas (List<T>) y diccionarios (Dictionary<TKey, TValue>).
using System.Collections.Generic;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Linq' ofrece funcionalidades avanzadas para filtrar, agrupar y manipular colecciones mediante expresiones Lambda.
using System.Linq;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Text' contiene clases para la manipulación de texto, incluyendo 'StringBuilder' para manejo eficiente de cadenas.
using System.Text;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Threading.Tasks' permite implementar programación asincrónica con la clase 'Task' y el uso de 'async/await'.
using System.Threading.Tasks;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// -------- ESPACIOS DE NOMBRES DE WPF --------

// 'System.Windows' contiene clases esenciales para la construcción de interfaces gráficas en aplicaciones WPF.
using System.Windows;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Controls' incluye una variedad de controles gráficos como botones, cajas de texto y listas desplegables.
using System.Windows.Controls;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Data' habilita la vinculación de datos entre la interfaz y la lógica del programa.
using System.Windows.Data;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Documents' permite manipular documentos de texto enriquecido dentro de una aplicación WPF.
using System.Windows.Documents;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Input' proporciona herramientas para gestionar la interacción del usuario mediante teclado y ratón.
using System.Windows.Input;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Media' contiene herramientas avanzadas para gráficos, colores y efectos visuales.
using System.Windows.Media;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Media.Animation' permite crear y gestionar animaciones dentro de los elementos de la interfaz gráfica.
using System.Windows.Media.Animation;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Media.Imaging' ofrece funcionalidades para trabajar con imágenes en WPF.
using System.Windows.Media.Imaging;

// 'System.Windows.Navigation' gestiona la navegación entre páginas en aplicaciones con múltiples vistas.
using System.Windows.Navigation;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.Windows.Shapes' incluye primitivas gráficas como rectángulos, círculos y líneas para la representación visual.
using System.Windows.Shapes;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// -------- ESPACIOS DE NOMBRES RELACIONADOS CON ARCHIVOS --------

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'System.IO' proporciona clases para la manipulación de archivos y directorios, como lectura, escritura y gestión de rutas.
using System.IO;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'IOPath' es un alias para 'System.IO.Path', que facilita el manejo de rutas de archivos sin escribir la referencia completa.
using IOPath = System.IO.Path;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// -------- BASE DE DATOS --------

// 'System.Data.SQLite' permite la interacción con bases de datos SQLite mediante consultas SQL y operaciones CRUD.
using System.Data.SQLite;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// 'Microsoft.Data.Sqlite' es una alternativa moderna para trabajar con bases de datos SQLite en proyectos .NET.
using Microsoft.Data.Sqlite;

// La palabra clave "using" se utiliza para importar espacios de nombres (namespaces).
// Un espacio de nombres es un conjunto de clases, funciones y herramientas ya creadas
// que puedes usar en tu código sin tener que escribir su nombre completo.

// -------- ESPACIOS DE NOMBRES PERSONALIZADOS --------

// 'ECHO.Recursos' es un espacio de nombres del proyecto que probablemente contiene recursos personalizados como imágenes, configuraciones o estilos.
using ECHO.Recursos;

// La palabra clave "namespace" se utiliza para organizar y agrupar clases relacionadas bajo un mismo nombre lógico.
// Esto ayuda a evitar conflictos de nombres y mejora la organización del código.
// En este caso, el espacio de nombres se llama WPF_ECHO.View y contiene las vistas de la aplicación.
// Aparte el namespace puede ser llamado como el nombre del programa.
namespace ECHO.View
{
    /// <summary>
    /// Lógica de interacción para RecordatorioItem.xaml
    /// </summary>
    /// 


    // Declaración de la clase 'RecordatorioItem', que hereda de 'UserControl'.
    // 'public' indica que la clase puede ser utilizada desde cualquier parte del código.
    // 'partial' significa que la definición de la clase puede estar dividida en varios archivos.
    // 'UserControl' es una clase base en WPF que permite crear controles personalizados con XAML y lógica C#.
    public partial class RecordatorioItem : UserControl
    {

        // Variable privada que indica si el recordatorio está marcado como destacado.
        // Se usa 'false' como valor inicial, lo que significa que el recordatorio comienza sin estar destacado.
        private bool estaDestacado = false;

        // Propiedad pública que expone si el recordatorio está destacado o no.
        // Se usa 'private set' para que solo esta clase pueda modificar el valor, evitando cambios externos inesperados.
        // Si quieres permitir modificaciones desde fuera, puedes cambiar 'private set' por 'public set'.
        public bool IsDestacado { get; private set; }

        // Evento que se dispara cuando el usuario marca un recordatorio como destacado.
        // Otros componentes de la aplicación pueden suscribirse a este evento para reaccionar al cambio.
        public event EventHandler RecordatorioDestacadoEvent;

        // Propiedad de solo lectura que devuelve el estado actual del recordatorio.
        // Se utiliza una expresión de cuerpo de miembro ('=>') para hacer el código más limpio y conciso.
        public bool EsDestacado => estaDestacado;

        // Evento que se activa cada vez que el estado de destacado cambia.
        // Se usa 'EventHandler<bool>' para que los suscriptores reciban un valor booleano indicando si el recordatorio está destacado o no.
        public event EventHandler<bool> DestacadoCambiado;

        // Evento que controla la visibilidad del recordatorio cuando se marca como destacado.
        // Se usa 'EventHandler<int>' para manejar el cambio de visibilidad basado en un identificador numérico.
        public event EventHandler<int> CambiarVisibilidadDesdeDestacado;

        // Propiedad dependiente que almacena la descripción del recordatorio.
        // Las 'DependencyProperty' permiten que las propiedades sean utilizadas en bindings dentro de la interfaz gráfica de WPF.
        public static readonly DependencyProperty DescripcionProperty =
            DependencyProperty.Register(nameof(Descripcion), typeof(string), typeof(RecordatorioItem));

        // Propiedad dependiente que almacena la fecha del recordatorio.
        // Se usa en la interfaz gráfica para enlazar la fecha del recordatorio con los elementos visuales.
        public static readonly DependencyProperty FechaProperty =
            DependencyProperty.Register(nameof(Fecha), typeof(string), typeof(RecordatorioItem));

        // Propiedad dependiente que almacena la hora del recordatorio.
        // Permite enlazar visualmente el valor en XAML sin necesidad de manejadores explícitos.
        public static readonly DependencyProperty HoraProperty =
            DependencyProperty.Register(nameof(Hora), typeof(string), typeof(RecordatorioItem));

        // Método 'get' que obtiene el valor de la propiedad 'Descripcion' desde la dependencia.
        // Método 'set' que asigna un valor a la propiedad y lo actualiza en la interfaz gráfica.
        public string Descripcion
        {
            get => (string)GetValue(DescripcionProperty);
            set => SetValue(DescripcionProperty, value);
        }

        // Métodos 'get' y 'set' para acceder a la fecha del recordatorio.
        // Se usa 'GetValue' para recuperar el valor desde la propiedad dependiente y 'SetValue' para actualizarlo.
        public string Fecha
        {
            get => (string)GetValue(FechaProperty);
            set => SetValue(FechaProperty, value);
        }

        // Métodos 'get' y 'set' para obtener o modificar la hora del recordatorio.
        // Permite que el valor de la hora se refleje correctamente en la interfaz de usuario.
        public string Hora
        {
            get => (string)GetValue(HoraProperty);
            set => SetValue(HoraProperty, value);
        }

        // Cadena de conexión a la base de datos.
        // Se define como 'readonly' y estática, lo que significa que no cambiará después de la inicialización.
        // Se obtiene desde la instancia global de contexto de la aplicación, lo que garantiza acceso centralizado a la base de datos.
        private static readonly string connectionString = AppContexto.Instancia.ConexionBD;


        // Constructor de la clase 'RecordatorioItem'.
        // Se ejecuta automáticamente cuando se crea una nueva instancia de esta clase.
        public RecordatorioItem()
        {
            // InitializeComponent() Inicializa los componentes definidos en el archivo XAML vinculado a esta clase,
            // asegurando que los elementos de la interfaz gráfica estén disponibles y listos para su uso.
            InitializeComponent(); // Llama al método que carga los elementos visuales y su configuración desde el archivo XAML.
        }

        // Se declara un evento que notificará cuando un recordatorio deba ser eliminado.
        // 'EventHandler' es un delegado que permite suscribirse a este evento y ejecutar acciones cuando se active.
        // Cuando se dispara 'EliminarRecordatorio', los métodos suscritos podrán realizar la eliminación del recordatorio.
        public event EventHandler EliminarRecordatorio;

        // 'void' indica que el método no devuelve ningún valor.
        // Está marcado como 'private', por lo que solo puede ser accedido desde esta clase.
        // 'object sender' representa el objeto (el botón) que generó el evento.
        // 'RoutedEventArgs e' contiene información adicional sobre el evento de clic.
        // Método que se ejecuta cuando el usuario hace clic en el botón de borrar.
        // 'sender' es el botón que disparó el evento y 'e' contiene la información del evento de clic.
        private void btnBorrar_Click(object sender, RoutedEventArgs e)
        {
            // Se activa el evento 'EliminarRecordatorio', notificando a los suscriptores que el recordatorio debe eliminarse.
            // Se usa el operador de propagación de eventos (?.) para evitar errores si no hay suscriptores al evento.
            // 'this' se pasa como el origen del evento y 'EventArgs.Empty' indica que no se envían datos adicionales.
            EliminarRecordatorio?.Invoke(this, EventArgs.Empty);
        }


        // Se declara un evento llamado 'EditarClicked' que se activará cuando el usuario desee editar un recordatorio.
        // 'EventHandler' permite que otros componentes se suscriban a este evento y reaccionen cuando se dispare.
        // Este evento no lleva parámetros adicionales, solo notifica que se ha realizado una acción de edición.
        public event EventHandler EditarClicked;


        // 'void' indica que el método no devuelve ningún valor.
        // Está marcado como 'private', por lo que solo puede ser accedido desde esta clase.
        // 'object sender' representa el objeto (el botón) que generó el evento.
        // 'RoutedEventArgs e' contiene información adicional sobre el evento de clic.
        // Método que se ejecuta cuando el usuario hace clic en el botón de editar.
        // 'sender' representa el origen del evento (el botón que fue presionado).
        // 'e' contiene información adicional sobre el evento de clic.
        private void BtnEditar_Click(object sender, RoutedEventArgs e)
        {
            // Se activa el evento 'EditarClicked', notificando a los suscriptores que se ha solicitado una edición.
            // Se usa el operador de propagación de eventos (?.) para evitar errores si no hay suscriptores al evento.
            // 'this' se pasa como el origen del evento y 'EventArgs.Empty' indica que no se envían datos adicionales.
            EditarClicked?.Invoke(this, EventArgs.Empty);
        }



        // Método para el corazón (Favorito)
        // 'void' indica que el método no devuelve ningún valor.
        // Está marcado como 'private', por lo que solo puede ser accedido desde esta clase.
        // 'object sender' representa el objeto (el botón) que generó el evento.
        // 'RoutedEventArgs e' contiene información adicional sobre el evento de clic.
        // Método que se ejecuta cuando el usuario hace clic en el botón para destacar o desmarcar un recordatorio.
        // Método que se ejecuta cuando el usuario hace clic en el botón para marcar o desmarcar un recordatorio como destacado.
        private void btnDestacado_Click(object sender, RoutedEventArgs e)
        {
            // Se obtiene el botón que disparó el evento.
            var btn = sender as Button;

            // Se accede al contenido del botón, que debe ser una imagen.
            var img = btn.Content as Image;

            // Se invierte el estado de destacado (si estaba en true, pasa a false y viceversa).
            estaDestacado = !estaDestacado;

            // Se actualiza la propiedad pública o enlazada 'IsDestacado' con el nuevo valor.
            IsDestacado = estaDestacado;

            // Se actualiza el texto del ToolTip según el nuevo estado.
            btnDestacado.ToolTip = estaDestacado
                ? "Desmarcar recordatorio"   // Si ahora está destacado, el texto sugiere desmarcar.
                : "Marcar como destacado";   // Si no está destacado, el texto sugiere marcar.

            // Se selecciona la imagen que se mostrará en el botón según el estado actual.
            var uri = estaDestacado
                ? "/Imagenes/EstrellaRellenada.png"         // Imagen de estrella llena si está destacado.
                : "/Imagenes/EstrellaVaciaAmarilla.png";    // Imagen de estrella vacía si no está destacado.

            // Se carga la imagen seleccionada en el botón.
            img.Source = new BitmapImage(new Uri(uri, UriKind.Relative));

            // Se intenta actualizar el estado del recordatorio en la base de datos SQLite.
            try
            {
                using (var connection = new SQLiteConnection(connectionString))
                {
                    connection.Open(); // Se abre la conexión a la base de datos.

                    // Consulta SQL para actualizar el campo 'Destacado' del recordatorio con el ID correspondiente.
                    string update = "UPDATE Recordatorios SET Destacado = @Destacado WHERE ID_Recordatorios = @ID";

                    // Se prepara el comando SQL con los parámetros correspondientes.
                    var command = new SQLiteCommand(update, connection);
                    command.Parameters.AddWithValue("@Destacado", estaDestacado ? 1 : 0); // 1 si es true, 0 si es false.
                    command.Parameters.AddWithValue("@ID", ID_Recordatorios); // Se especifica el ID del recordatorio.

                    command.ExecuteNonQuery(); // Se ejecuta la consulta de actualización.
                }
            }
            catch (Exception ex)
            {
                // En caso de error, se muestra un mensaje al usuario con los detalles.
                MessageBox.Show($"Error al actualizar destacado: {ex.Message}");
            }

            // Se notifica a los suscriptores del evento que el estado del recordatorio ha cambiado.
            RecordatorioDestacadoEvent?.Invoke(this, EventArgs.Empty);

            // Se informa a un agregador de eventos que el estado de destacado ha sido modificado.
            RecordatorioEventAggregator.RaiseDestacadoToggled(this, estaDestacado);

            // Se notifica que debe cambiar la visibilidad del recordatorio desde la vista de destacados, si aplica.
            CambiarVisibilidadDesdeDestacado?.Invoke(this, ID_Recordatorios);

            // Se lanza otro evento personalizado para indicar que el estado destacado ha cambiado.
            DestacadoCambiado?.Invoke(this, estaDestacado);
        }

        // Se declara una DependencyProperty llamada 'ID_RecordatoriosProperty'.
        // Esta propiedad estática y de solo lectura se registra con el sistema de propiedades de WPF.
        // Parámetros:
        // - nameof(ID_Recordatorios): el nombre de la propiedad asociada.
        // - typeof(int): el tipo de dato que manejará esta propiedad (entero).
        // - typeof(RecordatorioItem): el tipo de control o clase donde se usará (en este caso, un UserControl personalizado llamado RecordatorioItem).
        public static readonly DependencyProperty ID_RecordatoriosProperty =
            DependencyProperty.Register(nameof(ID_Recordatorios), typeof(int), typeof(RecordatorioItem));

        // Se define la propiedad CLR estándar 'ID_Recordatorios' que usa la DependencyProperty subyacente.
        // Esto permite trabajar con la propiedad como si fuera una propiedad normal en C#,
        // pero con las ventajas de las DependencyProperty (como enlaces, animaciones, herencia de valores, etc.).
        public int ID_Recordatorios
        {
            get => (int)GetValue(ID_RecordatoriosProperty);      // Obtiene el valor actual desde el sistema de propiedades de WPF.
            set => SetValue(ID_RecordatoriosProperty, value);    // Asigna un nuevo valor al sistema de propiedades de WPF.
        }


        // Método público que establece el estado de destacado desde un valor proveniente de la base de datos.
        // Se usa, por ejemplo, al cargar un recordatorio y reflejar si está o no marcado como destacado.
        public void SetEstaDestacadoDesdeBD(bool valor)
        {
            // Se asigna el valor recibido (desde la BD) a la variable booleana 'estaDestacado'.
            estaDestacado = valor;

            // También se actualiza la propiedad pública 'IsDestacado' para mantener coherencia en la interfaz.
            IsDestacado = valor; // <- ESTA LÍNEA FUE AGREGADA PARA REFLEJAR EL CAMBIO EXTERNAMENTE (vinculaciones, triggers, etc.)

            // Si el recordatorio está marcado como destacado...
            if (estaDestacado)
            {
                // Se establece un texto de ayuda indicando que se puede desmarcar.
                btnDestacado.ToolTip = "Desmarcar recordatorio";
            }

            // Si no está marcado como destacado...
            if (!estaDestacado)
            {
                // Se establece un texto de ayuda indicando que se puede marcar como destacado.
                btnDestacado.ToolTip = "Marcar como destacado";
            }

            // Se selecciona la imagen correspondiente dependiendo del estado:
            // - Estrella rellena si está destacado.
            // - Estrella vacía si no lo está.
            var uri = estaDestacado
                ? "/Imagenes/EstrellaRellenada.png"
                : "/Imagenes/EstrellaVaciaAmarilla.png";

            // Se actualiza la imagen del botón para reflejar visualmente el estado actual.
            imgDestacado.Source = new BitmapImage(new Uri(uri, UriKind.Relative));
        }


    }

}
